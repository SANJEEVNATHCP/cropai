<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Voice Agent - CropYield AI</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#16a34a',
                        secondary: '#15803d',
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #166534 0%, #15803d 50%, #16a34a 100%); }
        .glass { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); }
        
        /* Voice wave animation */
        .voice-wave {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 60px;
        }
        .voice-wave span {
            width: 6px;
            background: linear-gradient(to top, #16a34a, #22c55e);
            border-radius: 3px;
            animation: wave 1s ease-in-out infinite;
        }
        .voice-wave span:nth-child(1) { animation-delay: 0s; height: 20px; }
        .voice-wave span:nth-child(2) { animation-delay: 0.1s; height: 35px; }
        .voice-wave span:nth-child(3) { animation-delay: 0.2s; height: 50px; }
        .voice-wave span:nth-child(4) { animation-delay: 0.3s; height: 35px; }
        .voice-wave span:nth-child(5) { animation-delay: 0.4s; height: 20px; }
        
        @keyframes wave {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1); }
        }
        
        .voice-wave.inactive span {
            animation: none;
            height: 6px !important;
        }
        
        /* Pulse animation */
        .pulse-ring {
            animation: pulse-ring 1.5s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        /* Typing animation */
        .typing-dot {
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        /* Language selector styling */
        .lang-option { transition: all 0.2s; }
        .lang-option:hover { transform: scale(1.02); }
        /* Mobile menu */
        .mobile-menu { display: none; }
        .mobile-menu.active { display: block; }
        /* Language dropdown */
        .lang-dropdown { display: none; }
        .lang-dropdown.active { display: block; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
            <a href="/" class="flex items-center">
                <img src="/logo.svg" alt="CropYield AI" style="height: 50px; width: auto;">
            </a>
            <nav class="hidden md:flex space-x-6">
                <a href="/" class="hover:text-yellow-300 transition" data-i18n="nav_home">Home</a>
                <a href="/yield" class="hover:text-yellow-300 transition" data-i18n="nav_yield">Yield Prediction</a>
                <a href="/recommendation" class="hover:text-yellow-300 transition" data-i18n="nav_recommend">Crop Recommendation</a>
                <a href="/voice-agent" class="text-yellow-300 font-semibold" data-i18n="nav_voice">AI Voice Agent</a>
            </nav>
            <div class="flex items-center space-x-3">
                <div class="relative">
                    <button id="langBtnHeader" onclick="toggleLangDropdownHeader()" class="flex items-center space-x-1 bg-white/20 hover:bg-white/30 px-3 py-2 rounded-lg transition">
                        <span>üåê</span>
                        <span id="currentLangHeader" class="hidden sm:inline text-sm">English</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                    </button>
                    <div id="langDropdownHeader" class="lang-dropdown absolute right-0 mt-2 w-48 bg-white rounded-xl shadow-xl py-2 z-50 max-h-80 overflow-y-auto">
                        <button onclick="selectSiteLanguage('en')" class="lang-option w-full px-4 py-2 text-left text-gray-700 flex justify-between items-center"><span>English</span><span class="text-xs text-gray-400">English</span></button>
                        <button onclick="selectSiteLanguage('hi')" class="lang-option w-full px-4 py-2 text-left text-gray-700 flex justify-between items-center"><span>‡§π‡§ø‡§Ç‡§¶‡•Ä</span><span class="text-xs text-gray-400">Hindi</span></button>
                        <button onclick="selectSiteLanguage('mr')" class="lang-option w-full px-4 py-2 text-left text-gray-700 flex justify-between items-center"><span>‡§Æ‡§∞‡§æ‡§†‡•Ä</span><span class="text-xs text-gray-400">Marathi</span></button>
                        <button onclick="selectSiteLanguage('te')" class="lang-option w-full px-4 py-2 text-left text-gray-700 flex justify-between items-center"><span>‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</span><span class="text-xs text-gray-400">Telugu</span></button>
                        <button onclick="selectSiteLanguage('ta')" class="lang-option w-full px-4 py-2 text-left text-gray-700 flex justify-between items-center"><span>‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</span><span class="text-xs text-gray-400">Tamil</span></button>
                        <button onclick="selectSiteLanguage('kn')" class="lang-option w-full px-4 py-2 text-left text-gray-700 flex justify-between items-center"><span>‡≤ï‡≤®‡≥ç‡≤®‡≤°</span><span class="text-xs text-gray-400">Kannada</span></button>
                        <button onclick="selectSiteLanguage('bn')" class="lang-option w-full px-4 py-2 text-left text-gray-700 flex justify-between items-center"><span>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</span><span class="text-xs text-gray-400">Bengali</span></button>
                        <button onclick="selectSiteLanguage('gu')" class="lang-option w-full px-4 py-2 text-left text-gray-700 flex justify-between items-center"><span>‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä</span><span class="text-xs text-gray-400">Gujarati</span></button>
                        <button onclick="selectSiteLanguage('pa')" class="lang-option w-full px-4 py-2 text-left text-gray-700 flex justify-between items-center"><span>‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä</span><span class="text-xs text-gray-400">Punjabi</span></button>
                        <button onclick="selectSiteLanguage('or')" class="lang-option w-full px-4 py-2 text-left text-gray-700 flex justify-between items-center"><span>‡¨ì‡¨°‡¨º‡¨ø‡¨Ü</span><span class="text-xs text-gray-400">Odia</span></button>
                        <button onclick="selectSiteLanguage('ml')" class="lang-option w-full px-4 py-2 text-left text-gray-700 flex justify-between items-center"><span>‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç</span><span class="text-xs text-gray-400">Malayalam</span></button>
                    </div>
                </div>
            </div>
            
            <!-- Mobile Menu Button -->
            <button onclick="toggleMobileMenu()" class="md:hidden text-white p-2 order-last">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
        </div>
        <!-- Mobile Menu -->
        <div id="mobileMenu" class="mobile-menu md:hidden bg-green-800 px-4 py-3">
            <nav class="flex flex-col space-y-3">
                <a href="/" class="text-white hover:text-yellow-300 py-2">üè† Home</a>
                <a href="/yield" class="text-white hover:text-yellow-300 py-2">üìä Yield Prediction</a>
                <a href="/recommendation" class="text-white hover:text-yellow-300 py-2">üå± Crop Recommendation</a>
                <a href="/voice-agent" class="text-yellow-300 font-semibold py-2">üéôÔ∏è AI Voice Agent</a>
                <a href="/weather" class="text-white hover:text-yellow-300 py-2">üå§Ô∏è Weather</a>
            </nav>
        </div>
    </header>

    <!-- Page Title -->
    <section class="gradient-bg text-white py-6 md:py-12">
        <div class="container mx-auto px-4 text-center">
            <h2 id="pageTitle" class="text-xl md:text-4xl font-bold mb-2 md:mb-4">üéôÔ∏è AI Voice Agent</h2>
            <p id="pageSubtitle" class="text-sm md:text-xl text-green-100">Talk to our AI expert for farming advice</p>
        </div>
    </section>

    <main class="container mx-auto px-2 md:px-4 py-4 md:py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-8">
            
            <!-- Left: Voice Agent Interface -->
            <div class="lg:col-span-2 order-1">
                <div class="bg-white rounded-xl md:rounded-2xl shadow-xl overflow-hidden">
                    <!-- Agent Header -->
                    <div class="bg-gradient-to-r from-green-600 to-green-500 p-3 md:p-6 text-white">
                        <div class="flex items-center space-x-3 md:space-x-4">
                            <div class="w-10 h-10 md:w-16 md:h-16 bg-white rounded-full flex items-center justify-center text-xl md:text-3xl">ü§ñ</div>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-base md:text-xl font-bold truncate">Krishi AI</h3>
                                <p class="text-green-100 text-xs md:text-base truncate" id="agentStatus">Ready to help</p>
                            </div>
                            <div>
                                <span id="connectionStatus" class="px-2 md:px-3 py-1 bg-green-400 rounded-full text-xs md:text-sm">üü¢</span>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Container -->
                    <div id="chatContainer" class="h-64 md:h-96 overflow-y-auto p-3 md:p-6 space-y-3 md:space-y-4 bg-gray-50"></div>

                    <!-- Voice Input Section -->
                    <div class="p-3 md:p-6 bg-white border-t">
                        <div id="voiceWaveContainer" class="flex justify-center mb-3 md:mb-4 hidden">
                            <div class="voice-wave" id="voiceWave"><span></span><span></span><span></span><span></span><span></span></div>
                        </div>

                        <div class="flex items-center space-x-2 md:space-x-4">
                            <div class="flex-1 relative">
                                <input type="text" id="userInput" placeholder="Type or speak..." 
                                    class="w-full px-3 md:px-5 py-3 md:py-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 pr-10 md:pr-12 text-sm md:text-base">
                                <button onclick="sendMessage()" class="absolute right-2 md:right-3 top-1/2 -translate-y-1/2 text-green-600 hover:text-green-700 p-1">
                                    <svg class="w-5 h-5 md:w-6 md:h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                                </button>
                            </div>
                            
                            <button id="stopSpeakBtn" onclick="stopSpeaking()" 
                                class="hidden w-12 h-12 md:w-16 md:h-16 bg-red-600 hover:bg-red-700 text-white rounded-full flex items-center justify-center text-xl md:text-2xl shadow-lg transition flex-shrink-0">
                                <span>üîá</span>
                            </button>
                            
                            <button id="voiceBtn" onclick="toggleVoice()" 
                                class="w-12 h-12 md:w-16 md:h-16 bg-green-600 hover:bg-green-700 text-white rounded-full flex items-center justify-center text-xl md:text-2xl shadow-lg transition relative flex-shrink-0">
                                <span id="micIcon">üé§</span>
                                <div id="pulseRing" class="absolute inset-0 border-4 border-green-400 rounded-full pulse-ring hidden"></div>
                            </button>
                        </div>
                        
                        <p id="voiceStatus" class="text-center text-xs md:text-sm text-gray-500 mt-2">Tap mic to speak</p>
                    </div>
                </div>

                <!-- Quick Questions -->
                <div class="bg-white rounded-xl md:rounded-2xl shadow-xl p-4 md:p-6 mt-4 md:mt-6">
                    <h4 id="quickQuestionsTitle" class="font-bold text-gray-800 mb-3 md:mb-4 text-sm md:text-base">üí° Quick Questions</h4>
                    <div id="quickQuestionsContainer" class="flex flex-wrap gap-2"></div>
                </div>
            </div>

            <!-- Right: Info Panel -->
            <div class="space-y-4 md:space-y-6 order-2">
                <!-- Agent Info -->
                <div class="bg-white rounded-xl md:rounded-2xl shadow-xl p-4 md:p-6 hidden md:block">
                    <h3 id="aboutTitle" class="text-base md:text-xl font-bold text-gray-800 mb-3 md:mb-4">ü§ñ About Krishi AI</h3>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-3"><span class="text-2xl">üß†</span><div><p id="aiPoweredText" class="font-semibold text-gray-800">AI-Powered</p><p class="text-sm text-gray-500">Google Gemini AI</p></div></div>
                        <div class="flex items-center space-x-3"><span class="text-2xl">üé§</span><div><p id="voiceEnabledText" class="font-semibold text-gray-800">Voice Enabled</p><p id="speakToGetText" class="text-sm text-gray-500">Speak to get answers</p></div></div>
                        <div class="flex items-center space-x-3"><span class="text-2xl">üåæ</span><div><p id="farmingExpertText" class="font-semibold text-gray-800">Farming Expert</p><p id="cropsSoilWeatherText" class="text-sm text-gray-500">Crops, soil, weather & schemes</p></div></div>
                    </div>
                </div>

                <!-- Topics -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h3 id="topicsTitle" class="text-xl font-bold text-gray-800 mb-4">üìö I Can Help With</h3>
                    <div id="topicsContainer" class="space-y-2"></div>
                </div>

            </div>
        </div>
    </main>

    <footer class="gradient-bg text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center"><p>üåæ CropYield AI - Empowering Farmers with AI | ¬© 2025</p></div>
    </footer>

    <script>
        const API_BASE_URL = window.location.origin;
        let isListening = false, isSpeaking = false, recognition, synthesis = window.speechSynthesis;
        let currentLanguage = localStorage.getItem('siteLanguage') || 'en';
        let currentSpeechCode = 'en-IN', translations = {}, availableLanguages = [];

        const quickQuestions = {
            'en': [{ text: 'Best Kharif crops for my region', icon: 'üå±', color: 'green' },{ text: 'How to improve soil fertility?', icon: 'üß™', color: 'blue' },{ text: 'Rice disease prevention tips', icon: 'üåæ', color: 'orange' },{ text: 'Government farming schemes', icon: 'üí∞', color: 'yellow' }],
            'hi': [{ text: '‡§Æ‡•á‡§∞‡•á ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ñ‡§∞‡•Ä‡§´ ‡§´‡§∏‡§≤‡•á‡§Ç', icon: 'üå±', color: 'green' },{ text: '‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä ‡§ï‡•Ä ‡§â‡§∞‡•ç‡§µ‡§∞‡§§‡§æ ‡§ï‡•à‡§∏‡•á ‡§¨‡§¢‡§º‡§æ‡§è‡§Ç?', icon: 'üß™', color: 'blue' },{ text: '‡§ß‡§æ‡§® ‡§ï‡•Ä ‡§¨‡•Ä‡§Æ‡§æ‡§∞‡•Ä ‡§∏‡•á ‡§¨‡§ö‡§æ‡§µ', icon: 'üåæ', color: 'orange' },{ text: '‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§ï‡•É‡§∑‡§ø ‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Ç', icon: 'üí∞', color: 'yellow' }],
            'mr': [{ text: '‡§Æ‡§æ‡§ù‡•ç‡§Ø‡§æ ‡§≠‡§æ‡§ó‡§æ‡§∏‡§æ‡§†‡•Ä ‡§ñ‡§∞‡•Ä‡§™ ‡§™‡§ø‡§ï‡•á', icon: 'üå±', color: 'green' },{ text: '‡§Æ‡§æ‡§§‡•Ä ‡§∏‡•Å‡§™‡•Ä‡§ï‡§§‡§æ ‡§ï‡§∂‡•Ä ‡§µ‡§æ‡§¢‡§µ‡§æ‡§µ‡•Ä?', icon: 'üß™', color: 'blue' },{ text: '‡§≠‡§æ‡§§ ‡§∞‡•ã‡§ó ‡§™‡•ç‡§∞‡§§‡§ø‡§¨‡§Ç‡§ß', icon: 'üåæ', color: 'orange' },{ text: '‡§∏‡§∞‡§ï‡§æ‡§∞‡•Ä ‡§∂‡•á‡§§‡•Ä ‡§Ø‡•ã‡§ú‡§®‡§æ', icon: 'üí∞', color: 'yellow' }],
            'te': [{ text: '‡∞®‡∞æ ‡∞™‡±ç‡∞∞‡∞æ‡∞Ç‡∞§‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞ñ‡∞∞‡±Ä‡∞´‡±ç ‡∞™‡∞Ç‡∞ü‡∞≤‡±Å', icon: 'üå±', color: 'green' },{ text: '‡∞®‡±á‡∞≤ ‡∞∏‡∞æ‡∞∞‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞é‡∞≤‡∞æ ‡∞™‡±Ü‡∞Ç‡∞ö‡∞æ‡∞≤‡∞ø?', icon: 'üß™', color: 'blue' },{ text: '‡∞µ‡∞∞‡∞ø ‡∞µ‡±ç‡∞Ø‡∞æ‡∞ß‡∞ø ‡∞®‡∞ø‡∞µ‡∞æ‡∞∞‡∞£', icon: 'üåæ', color: 'orange' },{ text: '‡∞™‡±ç‡∞∞‡∞≠‡±Å‡∞§‡±ç‡∞µ ‡∞µ‡±ç‡∞Ø‡∞µ‡∞∏‡∞æ‡∞Ø ‡∞™‡∞•‡∞ï‡∞æ‡∞≤‡±Å', icon: 'üí∞', color: 'yellow' }],
            'ta': [{ text: '‡Æé‡Æ©‡Øç ‡Æ™‡Æï‡ØÅ‡Æ§‡Æø‡Æï‡Øç‡Æï‡ØÅ ‡Æï‡Ææ‡Æ∞‡Æø‡ÆÉ‡Æ™‡Øç ‡Æ™‡ÆØ‡Æø‡Æ∞‡Øç‡Æï‡Æ≥‡Øç', icon: 'üå±', color: 'green' },{ text: '‡ÆÆ‡Æ£‡Øç ‡Æµ‡Æ≥‡Æ§‡Øç‡Æ§‡Øà ‡ÆÖ‡Æ§‡Æø‡Æï‡Æ∞‡Æø‡Æ™‡Øç‡Æ™‡Æ§‡ØÅ ‡Æé‡Æ™‡Øç‡Æ™‡Æü‡Æø?', icon: 'üß™', color: 'blue' },{ text: '‡Æ®‡ØÜ‡Æ≤‡Øç ‡Æ®‡Øã‡ÆØ‡Øç ‡Æ§‡Æü‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ', icon: 'üåæ', color: 'orange' },{ text: '‡ÆÖ‡Æ∞‡Æö‡ØÅ ‡Æµ‡Æø‡Æµ‡Æö‡Ææ‡ÆØ ‡Æ§‡Æø‡Æü‡Øç‡Æü‡Æô‡Øç‡Æï‡Æ≥‡Øç', icon: 'üí∞', color: 'yellow' }]
        };

        document.addEventListener('DOMContentLoaded', async () => {
            await loadLanguages();
            await changeLanguage(currentLanguage);
            initSpeechRecognition();
            addWelcomeMessage();
        });

        async function loadLanguages() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/voice/languages`);
                const data = await response.json();
                if (data.success) { availableLanguages = data.languages; renderLanguageOptions(); }
            } catch (e) {
                availableLanguages = [{ code: 'en', name: 'English', native: 'English', speech_code: 'en-IN' },{ code: 'hi', name: 'Hindi', native: '‡§π‡§ø‡§Ç‡§¶‡•Ä', speech_code: 'hi-IN' }];
                renderLanguageOptions();
            }
        }

        function renderLanguageOptions() {
            // Language selection removed - using English only
        }

        async function changeLanguage(langCode) {
            currentLanguage = langCode;
            localStorage.setItem('siteLanguage', langCode);
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/voice/translations/${langCode}`);
                const data = await response.json();
                if (data.success) { translations = data.translations; currentSpeechCode = data.speech_code; applyTranslations(); }
                
                const topicsResponse = await fetch(`${API_BASE_URL}/api/voice/topics?lang=${langCode}`);
                const topicsData = await topicsResponse.json();
                if (topicsData.success) renderTopics(topicsData.topics);
            } catch (e) { console.error('Language change failed:', e); }
            
            if (recognition) recognition.lang = currentSpeechCode;
            renderQuickQuestions();
            
            // Update site navigation translations
            const trans = siteTranslations[langCode] || siteTranslations['en'];
            document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if (trans[key]) el.textContent = trans[key]; });
            if (document.getElementById('currentLangHeader')) document.getElementById('currentLangHeader').textContent = siteLanguageNames[langCode];
        }

        function applyTranslations() {
            document.getElementById('pageTitle').textContent = `üéôÔ∏è ${translations.voice_agent || 'AI Voice Agent'}`;
            document.getElementById('pageSubtitle').textContent = translations.talk_expert || 'Talk to our AI expert for instant farming advice';
            document.getElementById('agentStatus').textContent = translations.ready || 'Ready to help you';
            document.getElementById('voiceStatus').textContent = translations.mic_prompt || 'Click the mic to start speaking';
            document.getElementById('userInput').placeholder = translations.type_prompt || 'Type your question or click mic to speak...';
            document.getElementById('quickQuestionsTitle').textContent = `üí° ${translations.quick_questions || 'Quick Questions'}`;
            document.getElementById('aboutTitle').textContent = `ü§ñ ${translations.about || 'About Krishi AI'}`;
            document.getElementById('topicsTitle').textContent = `üìö ${translations.topics || 'I Can Help With'}`;
            
            // Update sidebar info panel
            if (document.getElementById('aiPoweredText')) document.getElementById('aiPoweredText').textContent = translations.ai_powered || 'AI-Powered';
            if (document.getElementById('voiceEnabledText')) document.getElementById('voiceEnabledText').textContent = translations.voice_enabled || 'Voice Enabled';
            if (document.getElementById('speakToGetText')) document.getElementById('speakToGetText').textContent = translations.speak_to_get || 'Speak to get answers';
            if (document.getElementById('farmingExpertText')) document.getElementById('farmingExpertText').textContent = translations.farming_expert || 'Farming Expert';
            if (document.getElementById('cropsSoilWeatherText')) document.getElementById('cropsSoilWeatherText').textContent = translations.crops_soil_weather || 'Crops, soil, weather & schemes';
        }

        function renderTopics(topics) {
            const colors = ['green', 'blue', 'orange', 'purple', 'yellow', 'pink', 'teal'];
            document.getElementById('topicsContainer').innerHTML = topics.map((t, i) => 
                `<div class="flex items-center px-3 py-2 bg-${colors[i % colors.length]}-50 rounded-lg"><span class="mr-2">${t.icon}</span><span class="text-sm text-gray-700">${t.name}</span></div>`
            ).join('');
        }

        function renderQuickQuestions() {
            const questions = quickQuestions[currentLanguage] || quickQuestions['en'];
            document.getElementById('quickQuestionsContainer').innerHTML = questions.map(q => 
                `<button onclick="askQuestion('${q.text.replace(/'/g, "\\'")}')" class="px-4 py-2 bg-${q.color}-50 text-${q.color}-700 rounded-full text-sm hover:bg-${q.color}-100 transition">${q.icon} ${q.text}</button>`
            ).join('');
        }

        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SR();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = currentSpeechCode;
                recognition.onresult = (e) => { document.getElementById('userInput').value = Array.from(e.results).map(r => r[0].transcript).join(''); };
                recognition.onend = () => { if (isListening) { stopListening(); if (document.getElementById('userInput').value.trim()) sendMessage(); } };
                recognition.onerror = () => stopListening();
            }
        }

        function addWelcomeMessage() {
            document.getElementById('chatContainer').innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-xl flex-shrink-0">ü§ñ</div>
                    <div class="bg-white rounded-2xl rounded-tl-none p-4 shadow-sm max-w-md">
                        <p class="text-gray-800">${translations.welcome || "Hello! I'm Krishi AI, your agricultural assistant."}</p>
                        <ul class="mt-2 space-y-1 text-sm text-gray-600">
                            <li>üé§ Click the mic to speak in your language</li>
                            <li>‚å®Ô∏è Or type your question below</li>
                            <li>üåæ Ask about crops, soil, weather, schemes!</li>
                        </ul>
                    </div>
                </div>`;
        }

        function toggleVoice() { isListening ? stopListening() : startListening(); }

        function startListening() {
            if (!recognition) { alert('Speech recognition not supported'); return; }
            recognition.lang = currentSpeechCode;
            isListening = true;
            recognition.start();
            document.getElementById('voiceBtn').classList.replace('bg-green-600', 'bg-red-500');
            document.getElementById('micIcon').textContent = '‚èπÔ∏è';
            document.getElementById('pulseRing').classList.remove('hidden');
            document.getElementById('voiceWaveContainer').classList.remove('hidden');
            document.getElementById('voiceWave').classList.remove('inactive');
            document.getElementById('voiceStatus').textContent = translations.listening || 'Listening... Speak now';
            document.getElementById('agentStatus').textContent = translations.listening || 'Listening...';
        }

        function stopListening() {
            isListening = false;
            if (recognition) recognition.stop();
            document.getElementById('voiceBtn').classList.replace('bg-red-500', 'bg-green-600');
            document.getElementById('micIcon').textContent = 'üé§';
            document.getElementById('pulseRing').classList.add('hidden');
            document.getElementById('voiceWave').classList.add('inactive');
            document.getElementById('voiceStatus').textContent = translations.mic_prompt || 'Click the mic to start speaking';
            document.getElementById('agentStatus').textContent = translations.ready || 'Ready to help you';
        }

        function askQuestion(q) { document.getElementById('userInput').value = q; sendMessage(); }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            if (!message) return;
            input.value = '';
            addMessage(message, 'user');
            const typingId = showTyping();
            document.getElementById('agentStatus').textContent = translations.thinking || 'Thinking...';

            try {
                const response = await fetch(`${API_BASE_URL}/api/voice/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, language: currentLanguage })
                });
                const data = await response.json();
                removeTyping(typingId);
                if (data.success) {
                    addMessage(data.response, 'agent');
                    document.getElementById('agentStatus').textContent = translations.ready || 'Ready to help you';
                    speak(data.response, data.speech_code || currentSpeechCode);
                } else {
                    addMessage('Sorry, please try again.', 'agent');
                }
            } catch (e) {
                removeTyping(typingId);
                addMessage('Connection error. Please try again.', 'agent');
            }
        }

        function addMessage(text, sender) {
            const container = document.getElementById('chatContainer');
            const isUser = sender === 'user';
            const formatted = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            const div = document.createElement('div');
            div.className = `flex items-start space-x-3 ${isUser ? 'flex-row-reverse space-x-reverse' : ''}`;
            div.innerHTML = `
                <div class="w-10 h-10 ${isUser ? 'bg-blue-100' : 'bg-green-100'} rounded-full flex items-center justify-center text-xl flex-shrink-0">${isUser ? 'üë§' : 'ü§ñ'}</div>
                <div class="${isUser ? 'bg-blue-500 text-white rounded-tr-none' : 'bg-white rounded-tl-none shadow-sm text-gray-800'} rounded-2xl p-4 max-w-md">${formatted}</div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function showTyping() {
            const container = document.getElementById('chatContainer');
            const id = 'typing-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'flex items-start space-x-3';
            div.innerHTML = `<div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-xl flex-shrink-0">ü§ñ</div>
                <div class="bg-white rounded-2xl rounded-tl-none p-4 shadow-sm"><div class="flex space-x-1">
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                </div></div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        function removeTyping(id) { const el = document.getElementById(id); if (el) el.remove(); }

        function speak(text, speechCode) {
            if (!synthesis) return;
            synthesis.cancel();
            
            // Clean text but preserve the content in the original language
            const clean = text.replace(/[\u{1F300}-\u{1F9FF}]/gu, '').replace(/\*\*/g, '').replace(/‚Ä¢/g, '');
            
            const utterance = new SpeechSynthesisUtterance(clean);
            utterance.lang = speechCode || currentSpeechCode;
            utterance.rate = 0.9;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            // Wait for voices to load
            const setVoice = () => {
                const voices = synthesis.getVoices();
                console.log(`[TTS] Available voices: ${voices.length}, Looking for: ${speechCode}`);
                
                // Try exact match first (e.g., 'hi-IN')
                let voice = voices.find(v => v.lang === speechCode);
                
                // If not found, try language code only (e.g., 'hi')
                if (!voice && speechCode) {
                    const langCode = speechCode.split('-')[0];
                    voice = voices.find(v => v.lang.startsWith(langCode));
                }
                
                // If still not found, try any Indian English voice for fallback
                if (!voice && speechCode && speechCode !== 'en-IN') {
                    voice = voices.find(v => v.lang === 'en-IN');
                }
                
                if (voice) {
                    utterance.voice = voice;
                    console.log(`[TTS] Using voice: ${voice.name} (${voice.lang})`);
                } else {
                    console.warn(`[TTS] No voice found for ${speechCode}, using default`);
                }
                
                isSpeaking = true;
                document.getElementById('voiceWaveContainer').classList.remove('hidden');
                document.getElementById('voiceWave').classList.remove('inactive');
                document.getElementById('agentStatus').textContent = translations.speaking || 'Speaking...';
                document.getElementById('stopSpeakBtn').classList.remove('hidden');
                document.getElementById('stopSpeakBtn').classList.add('flex');
                
                utterance.onstart = () => {
                    isSpeaking = true;
                };
                
                utterance.onend = () => {
                    isSpeaking = false;
                    document.getElementById('voiceWave').classList.add('inactive');
                    document.getElementById('voiceWaveContainer').classList.add('hidden');
                    document.getElementById('agentStatus').textContent = translations.ready || 'Ready to help you';
                    document.getElementById('stopSpeakBtn').classList.add('hidden');
                    document.getElementById('stopSpeakBtn').classList.remove('flex');
                };
                
                utterance.onerror = (e) => {
                    console.error('[TTS] Error:', e);
                    isSpeaking = false;
                    document.getElementById('voiceWave').classList.add('inactive');
                    document.getElementById('voiceWaveContainer').classList.add('hidden');
                    document.getElementById('agentStatus').textContent = translations.ready || 'Ready to help you';
                    document.getElementById('stopSpeakBtn').classList.add('hidden');
                    document.getElementById('stopSpeakBtn').classList.remove('flex');
                };
                
                synthesis.speak(utterance);
            };
            
            // Ensure voices are loaded before speaking
            if (synthesis.getVoices().length > 0) {
                setVoice();
            } else {
                synthesis.onvoiceschanged = setVoice;
            }
        }

        function stopSpeaking() {
            if (synthesis && isSpeaking) {
                synthesis.cancel();
                isSpeaking = false;
                document.getElementById('voiceWave').classList.add('inactive');
                document.getElementById('voiceWaveContainer').classList.add('hidden');
                document.getElementById('agentStatus').textContent = translations.ready || 'Ready to help you';
                document.getElementById('stopSpeakBtn').classList.add('hidden');
                document.getElementById('stopSpeakBtn').classList.remove('flex');
                console.log('[TTS] Speech stopped by user');
            }
        }
        
        document.getElementById('userInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
        
        // Debug function to check available voices
        function checkAvailableVoices() {
            const voices = speechSynthesis.getVoices();
            console.log('=== Available TTS Voices (' + voices.length + ') ===');
            voices.forEach(v => {
                console.log(`${v.name} (${v.lang}) ${v.default ? '- DEFAULT' : ''}`);
            });
            
            // Check for Indian language voices
            const indianVoices = voices.filter(v => v.lang.includes('-IN'));
            console.log(`\n=== Indian Voices (${indianVoices.length}) ===`);
            indianVoices.forEach(v => console.log(`${v.name} (${v.lang})`));
            
            // Log current language setting
            console.log(`\nCurrent Language: ${currentLanguage}`);
            console.log(`Current Speech Code: ${currentSpeechCode}`);
        }
        
        // Auto-check voices after page load
        setTimeout(() => {
            if (speechSynthesis.getVoices().length > 0) {
                checkAvailableVoices();
            } else {
                speechSynthesis.onvoiceschanged = () => {
                    checkAvailableVoices();
                };
            }
        }, 1000);
        
        // Make checkAvailableVoices available globally for manual testing
        window.checkAvailableVoices = checkAvailableVoices;
        
        // Site-wide language translations
        const siteTranslations = {
            'en': { nav_home: 'Home', nav_yield: 'Yield Prediction', nav_recommend: 'Crop Recommendation', nav_voice: 'AI Voice Agent' },
            'hi': { nav_home: '‡§π‡•ã‡§Æ', nav_yield: '‡§â‡§™‡§ú ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§µ‡§æ‡§£‡•Ä', nav_recommend: '‡§´‡§∏‡§≤ ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∂', nav_voice: 'AI ‡§µ‡•â‡§á‡§∏ ‡§è‡§ú‡•á‡§Ç‡§ü' },
            'mr': { nav_home: '‡§π‡•ã‡§Æ', nav_yield: '‡§â‡§§‡•ç‡§™‡§æ‡§¶‡§® ‡§Ö‡§Ç‡§¶‡§æ‡§ú', nav_recommend: '‡§™‡•Ä‡§ï ‡§∂‡§ø‡§´‡§æ‡§∞‡§∏', nav_voice: 'AI ‡§µ‡•ç‡§π‡•â‡§á‡§∏ ‡§è‡§ú‡§Ç‡§ü' },
            'te': { nav_home: '‡∞π‡±ã‡∞Æ‡±ç', nav_yield: '‡∞¶‡∞ø‡∞ó‡±Å‡∞¨‡∞°‡∞ø ‡∞Ö‡∞Ç‡∞ö‡∞®‡∞æ', nav_recommend: '‡∞™‡∞Ç‡∞ü ‡∞∏‡∞ø‡∞´‡∞æ‡∞∞‡∞∏‡±Å', nav_voice: 'AI ‡∞µ‡∞æ‡∞Ø‡∞ø‡∞∏‡±ç ‡∞è‡∞ú‡±Ü‡∞Ç‡∞ü‡±ç' },
            'ta': { nav_home: '‡ÆÆ‡ØÅ‡Æï‡Æ™‡Øç‡Æ™‡ØÅ', nav_yield: '‡Æµ‡Æø‡Æ≥‡Øà‡Æö‡Øç‡Æö‡Æ≤‡Øç ‡Æï‡Æ£‡Æø‡Æ™‡Øç‡Æ™‡ØÅ', nav_recommend: '‡Æ™‡ÆØ‡Æø‡Æ∞‡Øç ‡Æ™‡Æ∞‡Æø‡Æ®‡Øç‡Æ§‡ØÅ‡Æ∞‡Øà', nav_voice: 'AI ‡Æï‡ØÅ‡Æ∞‡Æ≤‡Øç ‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Øç' },
            'kn': { nav_home: '‡≤Æ‡≥Å‡≤ñ‡≤™‡≥Å‡≤ü', nav_yield: '‡≤á‡≤≥‡≥Å‡≤µ‡≤∞‡≤ø ‡≤ä‡≤π‡≥Ü', nav_recommend: '‡≤¨‡≥Ü‡≤≥‡≥Ü ‡≤∂‡≤ø‡≤´‡≤æ‡≤∞‡≤∏‡≥Å', nav_voice: 'AI ‡≤ß‡≥ç‡≤µ‡≤®‡≤ø ‡≤è‡≤ú‡≥Ü‡≤Ç‡≤ü‡≥ç' }
        };
        const siteLanguageNames = { 'en': 'English', 'hi': '‡§π‡§ø‡§Ç‡§¶‡•Ä', 'mr': '‡§Æ‡§∞‡§æ‡§†‡•Ä', 'te': '‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å', 'ta': '‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç', 'kn': '‡≤ï‡≤®‡≥ç‡≤®‡≤°' };
        
        function toggleLangDropdownHeader() { document.getElementById('langDropdownHeader').classList.toggle('active'); }
        document.addEventListener('click', (e) => { if (!e.target.closest('#langBtnHeader') && !e.target.closest('#langDropdownHeader')) document.getElementById('langDropdownHeader').classList.remove('active'); });
        
        function selectSiteLanguage(lang) {
            localStorage.setItem('siteLanguage', lang);
            const trans = siteTranslations[lang] || siteTranslations['en'];
            document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if (trans[key]) el.textContent = trans[key]; });
            document.getElementById('currentLangHeader').textContent = siteLanguageNames[lang];
            document.getElementById('langDropdownHeader').classList.remove('active');
            // Also update the chat language
            changeLanguage(lang);
        }
        
        // Initialize site language on load
        (function() {
            const savedLang = localStorage.getItem('siteLanguage') || 'en';
            const trans = siteTranslations[savedLang] || siteTranslations['en'];
            document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if (trans[key]) el.textContent = trans[key]; });
            if (document.getElementById('currentLangHeader')) document.getElementById('currentLangHeader').textContent = siteLanguageNames[savedLang];
        })();
        
        function toggleMobileMenu() {
            document.getElementById('mobileMenu').classList.toggle('active');
        }
    </script>
</body>
</html>
